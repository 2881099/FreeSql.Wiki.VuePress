import{_ as l}from"./plugin-vue_export-helper-DlAUqK2U.js";import{r as p,o as i,c as u,a as t,b as s,d as a,e,w as r}from"./app-Ce_3ofTC.js";const d={},k={href:"https://github.com/2881099/FreeSql.Cloud",target:"_blank",rel:"noopener noreferrer"},m={href:"https://github.com/dotnetcore/FreeSql/discussions/1066",target:"_blank",rel:"noopener noreferrer"},b={href:"https://github.com/2881099/FreeSql.Cloud",target:"_blank",rel:"noopener noreferrer"};function v(g,n){const o=p("ExternalLinkIcon"),c=p("RouterLink");return i(),u("div",null,[n[7]||(n[7]=t(`<h1 id="sharding" tabindex="-1"><a class="header-anchor" href="#sharding" aria-hidden="true">#</a> Sharding</h1><h2 id="theoretical-knowledge" tabindex="-1"><a class="header-anchor" href="#theoretical-knowledge" aria-hidden="true">#</a> Theoretical Knowledge</h2><p>Sharding - From a surface-level perspective, sharding involves splitting a single table into N smaller tables, each of which is a complete table on its own. After sharding, data is stored in these individual shard tables, with the main table acting as a shell. Data access happens within each shard table. Sharding improves the concurrent access capability of individual tables and also enhances disk I/O performance. The reason for increased concurrency is that the time required for a single query is reduced. In the case of high concurrency, the main table can distribute the load across different shard tables based on the query.</p><p>Database Sharding - This involves splitting the data originally stored in a single database across multiple databases, and splitting data originally stored in a single table across multiple tables. The amount of data in a database can become uncontrollable. Without sharding, as time and business grow, the number of tables in the database increases, and the amount of data in each table grows, leading to increased overhead for data operations (CRUD). Additionally, server resources (CPU, disk, memory, I/O, etc.) are limited, and eventually, the data volume and processing capacity of the database will hit a bottleneck.</p><h2 id="manual-sharding" tabindex="-1"><a class="header-anchor" href="#manual-sharding" aria-hidden="true">#</a> Manual Sharding</h2><p>FreeSql’s native usage and FreeSql.Repository repository methods provide the AsTable method for performing CRUD operations on sharded tables, for example:</p><div class="language-csharp line-numbers-mode" data-ext="cs"><pre class="language-csharp"><code><span class="token class-name"><span class="token keyword">var</span></span> repo <span class="token operator">=</span> fsql<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">GetRepository</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>Log<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
repo<span class="token punctuation">.</span><span class="token function">AsTable</span><span class="token punctuation">(</span>oldname <span class="token operator">=&gt;</span> <span class="token interpolation-string"><span class="token string">$&quot;</span><span class="token interpolation"><span class="token punctuation">{</span><span class="token expression language-csharp">oldname</span><span class="token punctuation">}</span></span><span class="token string">_201903&quot;</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Perform CRUD on Log_201903 table</span>
<span class="token comment">//repo.AsTable((type, oldname) =&gt; $&quot;{oldname}_201903&quot;); // Perform CRUD on Log_201903 table (cascading related tables also append this suffix)</span>

repo<span class="token punctuation">.</span><span class="token function">Insert</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">Log</span> <span class="token punctuation">{</span> <span class="token range operator">..</span><span class="token punctuation">.</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>For cross-database operations on the same database server, you can also use AsTable(oldname =&gt; $&quot;db2.dbo.{oldname}&quot;)</p><div class="language-csharp line-numbers-mode" data-ext="cs"><pre class="language-csharp"><code><span class="token comment">// Cross-table query</span>
<span class="token class-name"><span class="token keyword">var</span></span> sql <span class="token operator">=</span> fsql<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Select</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>User<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">AsTable</span><span class="token punctuation">(</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span> oldname<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token string">&quot;table_1&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">AsTable</span><span class="token punctuation">(</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span> oldname<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token string">&quot;table_2&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">ToSql</span><span class="token punctuation">(</span>a <span class="token operator">=&gt;</span> a<span class="token punctuation">.</span>Id<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//select * from (SELECT a.&quot;Id&quot; as1 FROM &quot;table_1&quot; a) ftb</span>
<span class="token comment">//UNION ALL</span>
<span class="token comment">//select * from (SELECT a.&quot;Id&quot; as1 FROM &quot;table_2&quot; a) ftb</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Summary of Sharding:</p><ul><li>For sharding and cross-database operations on the same server, AsTable can be used for CRUD operations;</li><li>AsTable with CodeFirst will automatically create non-existent shard tables;</li><li>Delayed loading cannot be used with sharded or sharded database entity types;</li></ul><p>For SQL Server cross-database transactions, you can use TransactionScope as follows:</p><div class="language-csharp line-numbers-mode" data-ext="cs"><pre class="language-csharp"><code><span class="token class-name"><span class="token keyword">var</span></span> repoLog <span class="token operator">=</span> fsql<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">GetRepository</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>Log<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name"><span class="token keyword">var</span></span> repoComment <span class="token operator">=</span> fsql<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">GetRepository</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>Comment<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
repoLog<span class="token punctuation">.</span><span class="token function">AsTable</span><span class="token punctuation">(</span>oldname <span class="token operator">=&gt;</span> <span class="token interpolation-string"><span class="token string">$&quot;</span><span class="token interpolation"><span class="token punctuation">{</span><span class="token expression language-csharp"><span class="token number">201903</span></span><span class="token punctuation">}</span></span><span class="token string">.dbo.</span><span class="token interpolation"><span class="token punctuation">{</span><span class="token expression language-csharp">oldname</span><span class="token punctuation">}</span></span><span class="token string">&quot;</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
repoComment<span class="token punctuation">.</span><span class="token function">AsTable</span><span class="token punctuation">(</span>oldname <span class="token operator">=&gt;</span> <span class="token interpolation-string"><span class="token string">$&quot;</span><span class="token interpolation"><span class="token punctuation">{</span><span class="token expression language-csharp"><span class="token number">201903</span></span><span class="token punctuation">}</span></span><span class="token string">.dbo.</span><span class="token interpolation"><span class="token punctuation">{</span><span class="token expression language-csharp">oldname</span><span class="token punctuation">}</span></span><span class="token string">&quot;</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">using</span> <span class="token punctuation">(</span><span class="token class-name">TransactionScope</span> ts <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">TransactionScope</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    repoComment<span class="token punctuation">.</span><span class="token function">Insert</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">Comment</span> <span class="token punctuation">{</span> <span class="token range operator">..</span><span class="token punctuation">.</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    repoLog<span class="token punctuation">.</span><span class="token function">Insert</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">Log</span> <span class="token punctuation">{</span> <span class="token range operator">..</span><span class="token punctuation">.</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    ts<span class="token punctuation">.</span><span class="token function">Complete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,13)),s("p",null,[n[1]||(n[1]=a("For distributed database TCC/SAGA solutions, please visit: ")),s("a",k,[n[0]||(n[0]=a("https://github.com/2881099/FreeSql.Cloud")),e(o)])]),n[8]||(n[8]=t(`<h2 id="automatic-sharding-beta" tabindex="-1"><a class="header-anchor" href="#automatic-sharding-beta" aria-hidden="true">#</a> Automatic Sharding (beta)</h2><p>Automatic sharding differs from CURD.AsTable method. Currently, the first phase supports automatic sharding by [time] (sharding across databases is not supported).</p><p>We encourage active participation in testing and feedback. Please prioritize using source code for testing to facilitate problem identification. Thank you.</p><div class="language-csharp line-numbers-mode" data-ext="cs"><pre class="language-csharp"><code><span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">Table</span><span class="token attribute-arguments"><span class="token punctuation">(</span>Name <span class="token operator">=</span> <span class="token string">&quot;as_table_log_{yyyyMM}&quot;</span><span class="token punctuation">,</span> AsTable <span class="token operator">=</span> <span class="token string">&quot;createtime=2022-1-1(1 month)&quot;</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
<span class="token keyword">class</span> <span class="token class-name">AsTableLog</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">Guid</span> id <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> msg <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">DateTime</span> createtime <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>From 2022-1-1 to the current time, create a new shard table every month, based on the createtime field</p></blockquote><blockquote><p>If the maximum date is greater than the current time, you can manually expand the shard table:</p></blockquote><div class="language-csharp line-numbers-mode" data-ext="cs"><pre class="language-csharp"><code><span class="token class-name"><span class="token keyword">var</span></span> tableName <span class="token operator">=</span> fsql<span class="token punctuation">.</span>CodeFirst<span class="token punctuation">.</span><span class="token function">GetTableByEntity</span><span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">AsTableLog</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span>AsTableImpl
    <span class="token punctuation">.</span><span class="token function">GetTableNameByColumnValue</span><span class="token punctuation">(</span>DateTime<span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span><span class="token string">&quot;2023-7-1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token named-parameter punctuation">autoExpand</span><span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Create database table</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>fsql<span class="token punctuation">.</span>DbFirst<span class="token punctuation">.</span><span class="token function">ExistsTable</span><span class="token punctuation">(</span>tableName<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
    fsql<span class="token punctuation">.</span>CodeFirst<span class="token punctuation">.</span><span class="token function">SyncStructure</span><span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">AsTableLog</span><span class="token punctuation">)</span><span class="token punctuation">,</span> tableName<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><table><thead><tr><th>Example</th><th>Description</th></tr></thead><tbody><tr><td>AsTable = &quot;createtime=2022-1-1(1 year)&quot;</td><td>Create a shard table every year</td></tr><tr><td>AsTable = &quot;createtime=2022-1-1(2 year)&quot;</td><td>Create a shard table every two years</td></tr><tr><td>AsTable = &quot;createtime=2022-1-1(1 month)&quot;</td><td>Create a shard table every month</td></tr><tr><td>AsTable = &quot;createtime=2022-1-1(3 month)&quot;</td><td>Create a shard table every three months</td></tr><tr><td>AsTable = &quot;createtime=2022-1-1(1 day)&quot;</td><td>Create a shard table every day</td></tr><tr><td>AsTable = &quot;createtime=2022-1-1(7 day)&quot;</td><td>Create a shard table every seven days</td></tr><tr><td>AsTable = &quot;createtime=2022-1-1(12 hour)&quot;</td><td>Create a shard table every 12 hours</td></tr></tbody></table><p>The first table is for 12 months, and the subsequent tables are for each month:</p><blockquote><p>AsTable = &quot;createtime=2022-1-1(12,1 month)&quot;</p></blockquote><p>The first table has a non-time-based name:</p><blockquote><p>fsql.CodeFirst.GetTableByEntity(typeof(AsTableLog)).AsTableImpl.SetTableName(0, &quot;CustomTableName&quot;)</p></blockquote><p>Sharding every month on the 1st at 10 AM:</p><blockquote><p>[Table(Name = &quot;as_table_log_{yyyyMMddHH}&quot;, AsTable = &quot;createtime=2022-1-1 10(1 month)&quot;)]</p></blockquote><p>When no time condition is set, only the latest 3 shard tables are used:</p><blockquote><p>fsql.CodeFirst.GetTableByEntity(typeof(AsTableLog)).AsTableImpl.SetDefaultAllTables(value =&gt; value.Take(3).ToArray());</p></blockquote>`,16)),s("p",null,[n[3]||(n[3]=a("For detailed information: ")),s("a",m,[n[2]||(n[2]=a("https://github.com/dotnetcore/FreeSql/discussions/1066")),e(o)])]),n[9]||(n[9]=t(`<p>Indexes for sharded tables can be set as follows: [Index(&quot;{tablename}_idx_01&quot;, &quot;phone&quot;)]</p><h2 id="db-sharding-common" tabindex="-1"><a class="header-anchor" href="#db-sharding-common" aria-hidden="true">#</a> [DB Sharding] Common</h2><ol><li>Sqlite Cross-database</li></ol><div class="language-csharp line-numbers-mode" data-ext="cs"><pre class="language-csharp"><code><span class="token punctuation">.</span><span class="token function">UseConnectionString</span><span class="token punctuation">(</span>DataType<span class="token punctuation">.</span>Sqlite<span class="token punctuation">,</span> <span class="token string">@&quot;data source=document.db;attachs=db2.db,db3.db&quot;</span><span class="token punctuation">)</span>

<span class="token punctuation">[</span><span class="token function">Table</span><span class="token punctuation">(</span>Name <span class="token operator">=</span> <span class="token string">&quot;db2.Comment&quot;</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
<span class="token keyword">class</span> <span class="token class-name">Comment</span> <span class="token punctuation">{</span> <span class="token range operator">..</span><span class="token punctuation">.</span> <span class="token punctuation">}</span>

<span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">Table</span><span class="token attribute-arguments"><span class="token punctuation">(</span>Name <span class="token operator">=</span> <span class="token string">&quot;db3.Comment&quot;</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
<span class="token keyword">class</span> <span class="token class-name">Topic</span> <span class="token punctuation">{</span> <span class="token range operator">..</span> <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>SQLite cross-database operations are a unique feature of FreeSql. Use the <code>attachs</code> parameter in the connection string, separated by commas.</p><ol start="2"><li>SqlServer Cross-database</li></ol><div class="language-csharp line-numbers-mode" data-ext="cs"><pre class="language-csharp"><code><span class="token comment">// Cross-database access within the same database instance</span>
<span class="token punctuation">[</span><span class="token function">Table</span><span class="token punctuation">(</span>Name <span class="token operator">=</span> <span class="token string">&quot;db2.dbo.tablename&quot;</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
<span class="token keyword">class</span> <span class="token class-name">Comment</span> <span class="token punctuation">{</span> <span class="token range operator">..</span><span class="token punctuation">.</span> <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>For different database instances, SQL Server linkserver technology can be used. Please refer to relevant documentation.</p><ol start="3"><li>Others</li></ol><p>Almost all databases support the dbo.table access method:</p><ul><li>MySql -&gt; dbname.tabname</li><li>PostgreSQL/SqlServer -&gt; dbname.schema.tbname</li></ul><p>You can set this in the <code>[Table(Name = ...)]</code> attribute or use the <code>.AsTable</code> method for the current context.</p><h2 id="db-sharding-freesql-cloud" tabindex="-1"><a class="header-anchor" href="#db-sharding-freesql-cloud" aria-hidden="true">#</a> [DB Sharding] FreeSql.Cloud</h2><p>FreeSql.Cloud provides cross-database access and distributed transaction solutions (TCC, SAGA), supporting .NET Core 2.1+, .NET Framework 4.0+.</p>`,14)),s("p",null,[n[5]||(n[5]=a("Open source address: ")),s("a",b,[n[4]||(n[4]=a("https://github.com/2881099/FreeSql.Cloud")),e(o)])]),n[10]||(n[10]=t(`<blockquote><p>dotnet add package FreeSql.Cloud</p></blockquote><p>or</p><blockquote><p>Install-Package FreeSql.Cloud</p></blockquote><div class="language-csharp line-numbers-mode" data-ext="cs"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">enum</span> <span class="token class-name">DbEnum</span> <span class="token punctuation">{</span> db1<span class="token punctuation">,</span> db2 <span class="token punctuation">}</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FreeSqlCloud</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">FreeSqlCloud<span class="token punctuation">&lt;</span>DbEnum<span class="token punctuation">&gt;</span></span></span> <span class="token comment">// Change DbEnum to string for multi-tenant management</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token function">FreeSqlCloud</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token keyword">base</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token function">FreeSqlCloud</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> distributeKey<span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token keyword">base</span><span class="token punctuation">(</span>distributeKey<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token class-name"><span class="token keyword">var</span></span> fsql <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">FreeSqlCloud</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
fsql<span class="token punctuation">.</span>DistributeTrace <span class="token operator">=</span> log <span class="token operator">=&gt;</span> Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>log<span class="token punctuation">.</span><span class="token function">Split</span><span class="token punctuation">(</span><span class="token char">&#39;\\n&#39;</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">Trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

fsql<span class="token punctuation">.</span><span class="token function">Register</span><span class="token punctuation">(</span>DbEnum<span class="token punctuation">.</span>db1<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">FreeSqlBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">UseConnectionString</span><span class="token punctuation">(</span>DataType<span class="token punctuation">.</span>Sqlite<span class="token punctuation">,</span> <span class="token string">@&quot;Data Source=db1.db&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
fsql<span class="token punctuation">.</span><span class="token function">Register</span><span class="token punctuation">(</span>DbEnum<span class="token punctuation">.</span>db2<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">FreeSqlBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">UseConnectionString</span><span class="token punctuation">(</span>DataType<span class="token punctuation">.</span>Sqlite<span class="token punctuation">,</span> <span class="token string">@&quot;Data Source=db2.db&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

services<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">AddSingleton</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>IFreeSql<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span>fsql<span class="token punctuation">)</span><span class="token punctuation">;</span>
services<span class="token punctuation">.</span><span class="token function">AddSingleton</span><span class="token punctuation">(</span>fsql<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>FreeSqlCloud must be defined as a singleton</p></blockquote><blockquote><p><code>new FreeSqlCloud()</code> manages multiple connections</p></blockquote><blockquote><p><code>new FreeSqlCloud(&quot;myapp&quot;)</code> activates TCC/SAGA transactions</p></blockquote><p>The access methods for FreeSqlCloud are the same as for IFreeSql:</p><div class="language-csharp line-numbers-mode" data-ext="cs"><pre class="language-csharp"><code>fsql<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Select</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>T<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
fsql<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Insert</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>T<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
fsql<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Update</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>T<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
fsql<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Delete</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>T<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//...</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol><li>Switching Databases (Thread-safe):</li></ol><div class="language-csharp line-numbers-mode" data-ext="cs"><pre class="language-csharp"><code>fsql<span class="token punctuation">.</span><span class="token function">Change</span><span class="token punctuation">(</span>DbEnum<span class="token punctuation">.</span>db2<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Select</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>T<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// In the same thread, or after async await, subsequent fsql.Select/Insert/Update/Delete operations will be on db2</span>

fsql<span class="token punctuation">.</span><span class="token function">Use</span><span class="token punctuation">(</span>DbEnum<span class="token punctuation">.</span>db2<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Select</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>T<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Effective for a single operation</span>

<span class="token keyword">using</span> <span class="token punctuation">(</span>fsql<span class="token punctuation">.</span><span class="token function">Change</span><span class="token punctuation">(</span>DbEnum<span class="token punctuation">.</span>db2<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//todo..</span>
<span class="token punctuation">}</span>
<span class="token comment">//FreeSql.Cloud v1.6.8 allows switching within a scope, and then switching back</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="2"><li>Automatic Database Routing Configuration:</li></ol><div class="language-csharp line-numbers-mode" data-ext="cs"><pre class="language-csharp"><code>fsql<span class="token punctuation">.</span>EntitySteering <span class="token operator">=</span> <span class="token punctuation">(</span>_<span class="token punctuation">,</span> e<span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
<span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span>EntityType <span class="token operator">==</span> <span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">User</span><span class="token punctuation">)</span><span class="token punctuation">)</span> e<span class="token punctuation">.</span>DBKey <span class="token operator">=</span> DbEnum<span class="token punctuation">.</span>db2<span class="token punctuation">;</span>
    <span class="token comment">// Automatically route queries for User to db2</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="3"><li>Static Repository Objects</li></ol><p>FreeSql.Repository/UnitOfWorkManager objects are created with a fixed IFreeSql instance, so they cannot follow FreeSqlCloud for database switching.</p><blockquote><p>Note: Once the same object instance is created, it cannot follow database switching. Creating a new object instance is not affected.</p></blockquote><p>In multi-tenant sharding scenarios, switch the database using <code>fsql.Change</code> before creating Repository/UnitOfWorkManager.</p>`,17)),s("p",null,[e(c,{to:"/en/guide/unitofwork-manager.html#extension-multi-database"},{default:r(()=>n[6]||(n[6]=[a("《How to Use UnitOfWorkManager with FreeSql.Cloud for AOP Transactions?》")])),_:1})]),n[11]||(n[11]=t(`<ol start="4"><li>Dynamic Object Creation (Not Recommended)</li></ol><p>However, there is a special requirement where the Repository should be able to follow <code>fsql.Change</code> for database switching after creation.</p><div class="language-csharp line-numbers-mode" data-ext="cs"><pre class="language-csharp"><code><span class="token class-name"><span class="token keyword">var</span></span> repo <span class="token operator">=</span> fsql<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">GetCloudRepository</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>User<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
fsql<span class="token punctuation">.</span><span class="token function">Change</span><span class="token punctuation">(</span>DbEnum<span class="token punctuation">.</span>db2<span class="token punctuation">)</span><span class="token punctuation">;</span>
Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>repo<span class="token punctuation">.</span>Orm<span class="token punctuation">.</span>Ado<span class="token punctuation">.</span>ConnectionString<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//repo -&gt; db2</span>
fsql<span class="token punctuation">.</span><span class="token function">Change</span><span class="token punctuation">(</span>DbEnum<span class="token punctuation">.</span>db1<span class="token punctuation">)</span><span class="token punctuation">;</span>
Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>repo<span class="token punctuation">.</span>Orm<span class="token punctuation">.</span>Ado<span class="token punctuation">.</span>ConnectionString<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//repo -&gt; db1</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>This mechanism is too uncontrollable, so only simple extension methods are provided. It is not recommended for IoC injection.</p>`,4))])}const q=l(d,[["render",v],["__file","sharding.html.vue"]]);export{q as default};
